<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 保持头部内容不变 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>相册浏览</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        <!-- 保持样式不变 -->
        .gallery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        /* 其他样式省略... */
    </style>
</head>
<body>
    <!-- 保持HTML结构不变 -->
    <div class="gallery-container">
        <!-- HTML内容省略... -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量保持不变
        let currentPage = 1;
        let perPage = 40;
        let totalImages = 0;
        let totalPages = 1;
        let allImages = [];
        let currentImageIndex = -1;
        let configuredFolders = [];
        
        let zoomLevel = 1;
        let rotation = 0;
        let flipped = false;
        
        // DOM元素获取保持不变
        // ...
        
        // 初始化保持不变
        document.addEventListener('DOMContentLoaded', () => {
            // 加载图片和文件夹配置
            loadFolders();
            loadImages();
            
            // 事件监听保持不变
            // ...
        });
        
        // 其他函数保持不变
        // ...
        
        // 修复加载图片函数，确保返回Promise
        function loadImages() {
            showLoading();
            
            // 关键修复：返回fetch Promise
            return fetch(`/api/images?page=${currentPage}&per_page=${perPage}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`加载图片失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    allImages = data.images || [];
                    totalImages = data.total_images || 0;
                    totalPages = data.total_pages || 1;
                    
                    // 更新UI
                    renderImages();
                    updatePagination();
                    hideLoading();
                    return data; // 返回数据以便链式调用
                })
                .catch(error => {
                    console.error('加载图片出错:', error);
                    showNotification('加载图片失败: ' + error.message, 'error');
                    hideLoading();
                    throw error; // 抛出错误以便链式调用捕获
                });
        }
        
        // 修复删除图片函数
        function deleteCurrentImage() {
            const imageId = deleteImageBtn.dataset.imageId;
            if (!imageId) return;
            
            if (confirm('确定要删除这张图片吗？此操作不可恢复。')) {
                fetch(`/api/images/${imageId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || '删除失败');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    showNotification(data.message, 'success');
                    
                    // 记录当前索引以便确定下一张图片
                    const deletedIndex = currentImageIndex;
                    
                    // 关闭模态框
                    imageModal.hide();
                    
                    // 重新加载当前页图片 - 使用正确的Promise处理
                    loadImages()
                        .then(() => {
                            // 如果还有图片，显示下一张或最后一张
                            if (allImages.length > 0) {
                                // 计算新索引 - 如果删除的是最后一张，显示前一张
                                const newIndex = deletedIndex < allImages.length ? deletedIndex : allImages.length - 1;
                                openImageModal(allImages[newIndex], newIndex);
                            } else if (currentPage > 1) {
                                // 当前页已无图片，跳转到上一页
                                goToPage(currentPage - 1);
                            }
                        })
                        .catch(error => {
                            console.error('重新加载图片失败:', error);
                        });
                })
                .catch(error => {
                    console.error('删除图片出错:', error);
                    showNotification('删除图片失败: ' + error.message, 'error');
                });
            }
        }
        
        // 修复移动图片函数中的类似问题
        function moveCurrentImage() {
            const imageId = moveImageBtn.dataset.imageId;
            const targetFolderIndex = targetFolderSelect.value;
            
            if (!imageId || targetFolderIndex === '') {
                showNotification('请选择目标文件夹', 'warning');
                return;
            }
            
            if (confirm('确定要移动这张图片吗？')) {
                fetch(`/api/images/${imageId}/move`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        target_folder_index: targetFolderIndex
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || '移动失败');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    showNotification(data.message, 'success');
                    
                    // 记录当前索引以便确定下一张图片
                    const currentIndex = currentImageIndex;
                    
                    // 关闭模态框
                    imageModal.hide();
                    
                    // 重新加载当前页图片 - 使用正确的Promise处理
                    loadImages()
                        .then(() => {
                            // 如果还有图片，显示下一张
                            if (allImages.length > 0) {
                                const newIndex = Math.min(currentIndex, allImages.length - 1);
                                openImageModal(allImages[newIndex], newIndex);
                            } else if (currentPage > 1) {
                                // 当前页已无图片，跳转到上一页
                                goToPage(currentPage - 1);
                            }
                        })
                        .catch(error => {
                            console.error('重新加载图片失败:', error);
                        });
                })
                .catch(error => {
                    console.error('移动图片出错:', error);
                    showNotification('移动图片失败: ' + error.message, 'error');
                });
            }
        }
        
        // 其他函数保持不变
        // ...
    </script>
</body>
</html>
