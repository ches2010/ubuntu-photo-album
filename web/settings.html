<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›¸å†Œè®¾ç½®</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç›¸å†Œè®¾ç½®</h1>
            <a href="/" class="settings-link">ğŸ  è¿”å›ç›¸å†Œ</a>
        </div>
        <div class="settings-form">
            <h2>é€šç”¨è®¾ç½®</h2>
            <label for="imagesPerRow">æ¯è¡Œæ˜¾ç¤ºç…§ç‰‡æ•°:</label>
            <input type="number" id="imagesPerRow" name="imagesPerRow" min="1" max="20" value="5">
            
            <h2>å›¾ç‰‡æ–‡ä»¶å¤¹</h2>
            <p style="font-size: 0.9em; color: #666; margin-top: -10px; margin-bottom: 10px;">
                <em>æ³¨æ„ï¼šæŒ‡å®šçš„æ–‡ä»¶å¤¹åŠå…¶æ‰€æœ‰å­æ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡éƒ½å°†è¢«åŒ…å«ã€‚</em>
            </p>
            <div id="folderInputs">
                <!-- Folder inputs will be dynamically added here -->
            </div>
            <button type="button" id="addFolder">+ æ·»åŠ æ–‡ä»¶å¤¹</button>
            
            <button id="saveSettings">ä¿å­˜è®¾ç½®</button>
            <div id="message" class="message"></div>
        </div>
    </div>

    <script>
        const folderInputsContainer = document.getElementById('folderInputs');
        const addFolderButton = document.getElementById('addFolder');
        const imagesPerRowInput = document.getElementById('imagesPerRow');
        const saveButton = document.getElementById('saveSettings');
        const messageDiv = document.getElementById('message');

        // API ç«¯ç‚¹
        const API_BASE_URL = '';
        const CONFIG_API_URL = `${API_BASE_URL}/api/config`;

        let folderCount = 0;

        function createFolderInput(folderPath = '') {
            folderCount++;
            const folderDiv = document.createElement('div');
            folderDiv.className = 'folder-input-group';
            folderDiv.innerHTML = `
                <label for="folder_${folderCount}">æ–‡ä»¶å¤¹è·¯å¾„ ${folderCount}:</label>
                <input type="text" id="folder_${folderCount}" name="folder_${folderCount}" value="${folderPath}" placeholder="/path/to/your/images">
                <button type="button" class="remove-folder" data-folder-id="folder_${folderCount}">-</button>
            `;
            folderInputsContainer.appendChild(folderDiv);
            
            // Add event listener to the new remove button
            folderDiv.querySelector('.remove-folder').addEventListener('click', function() {
                const folderId = this.getAttribute('data-folder-id');
                removeFolderInput(folderId);
            });
        }

        function removeFolderInput(folderId) {
            const inputGroup = document.querySelector(`.folder-input-group input[name='${folderId}']`).parentElement;
            if (inputGroup) {
                inputGroup.remove();
                // Optionally, we could decrement folderCount, but it's not strictly necessary
                // as we only use it for creating new unique IDs. Reusing IDs after deletion
                // could be problematic if not handled carefully in the backend config parsing.
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–å½“å‰é…ç½®
        async function loadSettings() {
            try {
                const response = await fetch(CONFIG_API_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const configData = await response.json();
                
                if (configData.settings) {
                    // Load images per row
                    if (configData.settings.images_per_row !== undefined) {
                        imagesPerRowInput.value = configData.settings.images_per_row;
                    }

                    // Load folders - find all keys starting with 'folder_'
                    const folderKeys = Object.keys(configData.settings).filter(key => key.startsWith('folder_'));
                    folderKeys.sort(); // Sort to maintain order if possible
                    
                    folderInputsContainer.innerHTML = ''; // Clear existing
                    folderCount = 0; // Reset counter
                    
                    folderKeys.forEach(key => {
                        const folderPath = configData.settings[key];
                        if (folderPath) { // Only add if path is not empty
                             createFolderInput(folderPath);
                        }
                    });
                    
                    // Ensure at least one input field exists
                    if (folderCount === 0) {
                        createFolderInput();
                    }
                }
            } catch (error) {
                console.error("åŠ è½½è®¾ç½®å¤±è´¥:", error);
                showMessage("åŠ è½½è®¾ç½®å¤±è´¥: " + error.message, "error");
                // Ensure at least one input field exists on error
                if (folderCount === 0) {
                    createFolderInput();
                }
            }
        }

        // ä¿å­˜è®¾ç½®
        async function saveSettings() {
            const newImagesPerRow = parseInt(imagesPerRowInput.value, 10);
            if (isNaN(newImagesPerRow) || newImagesPerRow < 1 || newImagesPerRow > 20) {
                showMessage("æ¯è¡Œç…§ç‰‡æ•°å¿…é¡»æ˜¯ 1 åˆ° 20 ä¹‹é—´çš„æ•´æ•°ã€‚", "error");
                return;
            }

            const folderInputs = document.querySelectorAll('#folderInputs input[type="text"]');
            const folders = {};
            let hasValidFolder = false;

            folderInputs.forEach((input, index) => {
                const value = input.value.trim();
                const key = `folder_${index + 1}`; // Use sequential keys
                folders[key] = value; // Store even if empty, backend handles it
                if (value) {
                    hasValidFolder = true;
                }
            });

            if (!hasValidFolder) {
                showMessage("è¯·è‡³å°‘é…ç½®ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„ã€‚", "error");
                return;
            }

            // Include images_per_row in the settings object
            const payload = {
                settings: {
                    images_per_row: newImagesPerRow.toString(), // Ensure it's a string
                    ...folders // Spread the folder entries
                }
            };

            console.log("Saving payload:", payload); // For debugging

            try {
                const response = await fetch(CONFIG_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (response.ok) {
                    showMessage(data.message || "è®¾ç½®å·²ä¿å­˜ã€‚", "success");
                    // å¯é€‰ï¼šæç¤ºç”¨æˆ·åˆ·æ–°ç›¸å†Œé¡µé¢ä»¥åº”ç”¨æ›´æ”¹
                    // setTimeout(() => { window.location.href = '/'; }, 1000);
                } else {
                    throw new Error(data.error || "ä¿å­˜å¤±è´¥");
                }
            } catch (error) {
                console.error("ä¿å­˜è®¾ç½®å¤±è´¥:", error);
                showMessage("ä¿å­˜è®¾ç½®å¤±è´¥: " + error.message, "error");
            }
        }

        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            // å¯é€‰ï¼šå‡ ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯
            // setTimeout(() => { messageDiv.textContent = ''; messageDiv.className = 'message'; }, 5000);
        }

        addFolderButton.addEventListener('click', () => createFolderInput());
        saveButton.addEventListener('click', saveSettings);

        // Attach event listeners to existing remove buttons after load
        document.addEventListener('click', function(e) {
             if (e.target && e.target.classList.contains('remove-folder')) {
                 const folderId = e.target.getAttribute('data-folder-id');
                 removeFolderInput(folderId);
             }
        });

        window.onload = loadSettings;
    </script>
</body>
</html>



